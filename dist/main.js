$(function(){});var app=angular.module("NowPlaying",[]),defaultImgURL="http://4.bp.blogspot.com/-hIirVYTQFRs/TwdWvcq55uI/AAAAAAAACt8/3frSkQULrn4/s320/film-reel.jpg",defaultProfileImg="images/movie_reel.png",myFirebase="https://boiling-fire-3340.firebaseio.com/movies/";app.controller("mainCtrl",function($scope,xbmcFactory,tmdbFactory,movieListFactory,configuration){$scope.glob={},$scope.glob.fbMovies={},$scope.glob.moviePicks={},$scope.glob.scottPickins=!1,$scope.glob.username="",$scope.glob.flipped=!1,$scope.glob.opacity=!0,$scope.curMovie={},$scope.curMovie.title="",$scope.curMovie.idx=0,$scope.img={},$scope.img={url:defaultImgURL},$scope.tmdb={},$scope.tmdb.movieInfo={},$scope.tmdb.imgPath=tmdbFactory.getImagePath(),configuration.initialize(),$scope.glob.posterURLs=configuration.loadPosterURLs(),$scope.glob.username=configuration.setUser(),$scope.glob.username&&($scope.glob.scottPickins=!0),$scope.$watch("glob.scottPickins",function(){$scope.glob.scottPickins&&$scope.loadFbMovies()}),$scope.setCurMovie=function(title){$scope.curMovie.title=title},$scope.setImg=function(url){$scope.img.url=url},$scope.getMovieList=function(){var promise=movieListFactory.getSelectedMovies($scope.glob.username);promise.then(function(movieList){$scope.glob.fbMovies=movieList},function(reason){alert("Failed: "+reason)})},$scope.loadFbMovies=function(){var promise=movieListFactory.getSelectedMovies($scope.glob.username);promise.then(function(movieList){$scope.glob.fbMovies=movieList,$scope.glob.moviePicks=movieList},function(reason){alert("Failed: "+reason)})};var promise=xbmcFactory.getMovieCache();promise.then(function(movieCache){$scope.cache=movieCache})}),app.controller("profileCtrl",function($scope,rottenTomatoesFactory,tmdbFactory,xbmcFactory,movieListFactory){$scope.profile={},$scope.profile.img={url:defaultProfileImg},$scope.removeMovie=function(idx,fbIdx){delete $scope.glob.moviePicks[idx],movieListFactory.removeMovie({user:$scope.glob.username,fbIdx:fbIdx})},$scope.openTMDB=function(movieId){window.open("http://www.themoviedb.org/movie/"+movieId,"tmdb")},$scope.$watch("curMovie.title",function(nv,ov){if(nv!=ov){var promise=rottenTomatoesFactory.getMovie($scope.curMovie.title);promise.then(function(movieInfo){$scope.profile.img={url:movieInfo.movies[0].posters.original}},function(reason){alert("Failed: "+reason)});var promise2=tmdbFactory.getMovie($scope.curMovie.title);promise2.then(function(movieInfo){$scope.tmdb.movieInfo=movieInfo.results[0],$scope.setImg($scope.tmdb.imgPath+movieInfo.results[0].poster_path)},function(reason){alert("Failed: "+reason)})}})}),app.controller("MovieListCtrl",function($scope,$location,$anchorScroll,xbmcFactory,rottenTomatoesFactory,movieListFactory){xbmcFactory.setupBookmarks($scope);var promise=xbmcFactory.getMovies();promise.then(function(movieData){$scope.data=movieData}),$scope.selectMovie=function(idx,title){$scope.setCurMovie(title),$scope.selectedRow=idx},$scope.togglePick=function(idx,title){if($scope.glob.moviePicks[idx])movieListFactory.removeMovie({user:$scope.glob.username,fbIdx:$scope.glob.moviePicks[idx].fbIdx}),delete $scope.glob.moviePicks[idx];else{var id=movieListFactory.addMovie({user:$scope.glob.username,title:title,idx:idx});$scope.glob.moviePicks[idx]={fbIdx:id,title:title}}},$scope.highlightMovie=function(idx){$scope.highlightedRow=idx},$scope.leaveMovieList=function(){$scope.highlightedRow="noHighlightedRow"},$scope.jumpToBM=function(bm){if("Admission"!=$scope.curMovie.title&&"Captain America: The First Avenger"!=$scope.curMovie.title||"S"!=bm)if("Admission"!=$scope.curMovie.title&&"Jiro Dreams of Sushi"!=$scope.curMovie.title||"J"!=bm){$scope.curMovie.BM=bm,"#"==bm&&(bm="firstMovie");var pos=$("."+bm).position().top-$("#movie0").position().top;$("#movieList").animate({scrollTop:pos},2500)}else $scope.glob.scottPickins=!0,$scope.glob.username="josh";else $scope.glob.scottPickins=!0,$scope.glob.username="scott"},$scope.getFlags=function(xbmcId){return $scope.cache[xbmcId]?!0:!1}}),app.controller("FooterCtrl",function($scope){$scope.toggleOpacity=function(){$scope.glob.opacity=!$scope.glob.opacity}}),app.service("configuration",function(xbmcFactory,tmdbFactory,rottenTomatoesFactory){this.sayHello=function(){return"Hello, World!"},this.initialize=function(){var i=0,configArr=[],promise=xbmcFactory.getMovies();promise.then(function(xbmcList){$.each(xbmcList,function(){configArr[this.movieId]=this;var that=this;if(i++>3)return!1;var promise=tmdbFactory.getMovie(this.title);promise.then(function(tmdbMovie){configArr[that.movieId].tmdb=tmdbMovie})})})},this.setUser=function(){return-1!=location.search.indexOf("u=")?location.search.slice(3):!1},this.loadPosterURLs=function(){var promise=rottenTomatoesFactory.loadPosterURLs();promise.then(function(posters){return posters},function(reason){alert("Failed: "+reason)})}}),app.factory("xbmcFactory",function($q,$http){return{getMovies:function(){var deferred=$q.defer();return $http.get("php/movies.json").then(function(d){var movieData=addBookmarks(d.data.result.movies);deferred.resolve(angular.fromJson(movieData))}),deferred.promise},setupBookmarks:function(scope){scope.alphabet=["#","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","R","S","T","U","V","W","X","Y","Z"]},getMovieCache:function(){var deferred=$q.defer();return $http.get("php/movieCache.json").then(function(d){var movieCache=[];$.each(d.data.result.movies,function(){movieCache[this.xbmcId]=[],movieCache[this.xbmcId].tmdbId=this.tmdbId}),deferred.resolve(movieCache)}),deferred.promise}}}),app.factory("rottenTomatoesFactory",function($q,$http){var rtLinks={getMovie:"http://api.rottentomatoes.com/api/public/v1.0/movies.json?apikey=jq7aydjmufspr54dcffw7f66&q=[movietitle]&page_limit=1&callback=JSON_CALLBACK"};return{getMovie:function(movie){var deferred=$q.defer(),findMovie=rtLinks.getMovie.replace("[movietitle]",movie);return $http.jsonp(findMovie).then(function(d){0==d.data.total&&(d.data.movies[0].posters.original=defaultImgURL),deferred.resolve(d.data)}),deferred.promise},loadPosterURLs:function(){var deferred=$q.defer();return $http.get("php/posters.json").then(function(d){deferred.resolve(d.data)}),deferred.promise}}}),app.factory("tmdbFactory",function($q,$http){var tmdbLinks={getMovieByName:"http://api.themoviedb.org/3/search/movie?api_key=829f2c4b8c9c5304ea86fc7cf47b1053&query=[movietitle]&callback=JSON_CALLBACK"};return{getMovie:function(movie){var deferred=$q.defer(),findMovie=tmdbLinks.getMovieByName.replace("[movietitle]",movie.replace(" ","+"));return $http.jsonp(findMovie).then(function(d){deferred.resolve(d.data)}),deferred.promise},getImagePath:function(){return"http://d3gtl9l2a4fn1j.cloudfront.net/t/p/original/"}}}),app.factory("movieListFactory",function($q,$http){new Firebase(myFirebase);return{removeMovie:function(data){var ref=new Firebase(myFirebase+data.user+"/"+data.fbIdx);ref.remove()},addMovie:function(data){var ref=new Firebase(myFirebase+data.user);return newRef=ref.push({idx:data.idx,title:data.title}),newRef.name()},getSelectedMovies:function(username){var deferred=$q.defer();return $http.get(myFirebase+username+".json").then(function(d){if("null"!==d.data)var obj=convertFbToMl(d.data);else var obj={};deferred.resolve(obj)}),deferred.promise}}}),app.directive("NOT_USED_mySelectFirstMovie",function(){return function(scope,element){scope.$first&&element.addClass("xxxxxxx")}}),app.directive("bnFadeHelper",function(){function compile(element){return element.prepend("<img class='fader' />"),link}function link($scope,element){function initFade(fadeSource){fader.prop("src",fadeSource).addClass("show"),primary.one("load",startFade)}function isFading(){return fader.hasClass("show")||fader.hasClass("fadeOut")}function startFade(){fader.width(),fader.addClass("fadeOut"),setTimeout(teardownFade,250)}function teardownFade(){fader.removeClass("show fadeOut")}var fader=element.find("img.fader"),primary=element.find("img.image");$scope.$watch("profile.img.url",function(newValue,oldValue){newValue!==oldValue&&(isFading()||initFade(oldValue))})}return{compile:compile,restrict:"A"}}),app.filter("cut",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!=lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" â€¦")}});